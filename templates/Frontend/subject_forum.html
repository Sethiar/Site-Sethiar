{% extends 'base.html.jinja2' %}

{% block head_content %}
    <meta name="description" content="Forum du blog permettant de discuter, interagir et donner son avis sur le blog.">
    <title>{% block title %}Bienvenue sur le forum du blog{% endblock %}</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='CSS/subject_forum.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
{% endblock %}

    {% block header_content %}
    {% endblock %}

{% block main_content %}
<br>
<h1>Forum de discussion</h1>
<section id="categories">
    <div id="forum-pic">
        <div id="forum-pic-left">
            <img src="{{ url_for('static', filename='Images/images_forum/forum4.jpg') }}" alt="Forum Image Left">
        </div>
        <div id="forum-pic-center">
            <img src="{{ url_for('static', filename='Images/images_accueil/forum1.jpg') }}" alt="Forum Image Center">
        </div>
        <div id="forum-pic-right">
            <img src="{{ url_for('static', filename='Images/images_forum/forum5.jpg') }}" alt="Forum Image Right">
        </div>
    </div>
    <br><br><br><br><br><br>
    <div id="container-subject-forum">
        <h2>Discussion sur le sujet : </h2>
        <br>
        <label>{{ subject.nom }}</label>
    </div>
    <div id="container-comment">
        {% for comment in comment_subject %}
        <div id="comment">
            <div class="comment-header">
                <img src="{{ url_for('user.profil_photo', user_id=comment.user_id) }}" alt="Photo de profil" class="profile-picture">
            </div>
            <div class="comment">
                <strong>{{ comment.user.pseudo }}</strong> a commenté :
            </div>
            <div class="comment">
                <i>{{ comment.user.role }}</i>
            </div>
            <div class="date-comment">
                <small>Le {{ moment(comment.comment_date).format('DD-MM-YYYY à HH:mm') }}</small>
            </div>
            <div class="content-comment">
                {{ comment.comment_content | replace('\n', '<br>') | safe }}
            </div>
            <div>
                {% if comment.user_id == current_user.id %}
                <button class="change-button"><a href="{{ url_for('user.change_comment', id=comment.id) }}">Modifier le commentaire</a></button>
                <form action="{{ url_for('user.delete_comment', id=comment.id) }}" method="POST" style="display:inline;">
                    {{ formsuppress.csrf_token }}
                    <input class="suppress-button" type="submit" value="Supprimer le commentaire" onclick="return confirm('Êtes vous certain de vouloir supprimer votre commentaire ?');">
                </form>
                {% endif %}
            </div>
        </div>
        <div class="reply-button-container">
            <a href="{{ url_for('user.reply_form_subject', comment_id=comment.id, user_pseudo=current_user.pseudo) }}" class="reply-button">Répondre</a>
            <div class="like-section" data-user-id="{{ current_user.pseudo }}">
                <form id="formlikecomment" method="POST" action="{{ url_for('user.likes_comment_subject') }}" style="display: none;">
                    {{ formlikecomment.csrf_token }}
                    <input type="hidden" name="comment_id" value="{{ comment.id }}">
                    <input type="hidden" name="user_pseudo" value="{{ current_user.pseudo }}">
                    <button type="submit" class="like-submit"></button>
                </form>
                <div class="like-icon" data-comment-id="{{ comment.id }}" onclick="toggleLike(this, '{{ comment.id }}', '{{ current_user.pseudo }}')" style="cursor: pointer;">
                    {% if comment_likes_data[comment.id].liked_by_current_user %}
                    &#9829; <!-- Icône pour un cœur plein -->
                    {% else %}
                    &#9825; <!-- Icône pour un cœur vide -->
                    {% endif %}
                </div>
                <div class="liked-users">
                    <p id="like-message-{{ comment.id }}">
                        {% set like_data = comment_likes_data[comment.id] %}
                        {% if like_data.like_count == 1 %}
                            1 utilisateur a aimé le commentaire.
                        {% elif like_data.like_count > 1 %}
                            {{ like_data.like_count}} utilisateurs ont aimé le commentaire.
                        {% else %}
                            Personne n'a aimé le commentaire pour le moment.
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="replies">
            {% for reply in comment.replies %}
            <div class="comment-reply">
                <div class="reply-header">
                    <img src="{{ url_for('user.profil_photo', user_id=reply.user_id) }}" alt="Photo de profil" class="profile-picture">
                    <div class="reply-details">
                        <strong><i>{{ reply.user.pseudo }}</i></strong> a répondu :
                    </div>
                    <div class="reply-details">
                        <i>{{ reply.user.role }}</i>
                    </div>
                    <div class="reply-date">
                         <small>Le {{ moment(reply.reply_date).format('DD-MM-YYYY à HH:mm') }}</small>
                    </div>
                </div>
                <div class="content-reply">
                    {{ reply.reply_content | replace('\n', '<br>') | safe }}
                </div>
                <div class="change-reply">
                {% if reply.user_id == current_user.id %}
                    <button class="change-button"><a href="{{ url_for('user.change_reply', id=reply.id) }}">Modifier la réponse</a></button>
                    <form action="{{ url_for('user.delete_reply', id=reply.id) }}" method="POST" style="display:inline;">
                    {{ formsuppressreply.csrf_token }}
                        <input class="suppress-button" type="submit" value="Supprimer la réponse" onclick="return confirm('Êtes vous certain de vouloir supprimer votre réponse ?');">
                    </form>
                {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
    <div class="separation"></div>
    <br>
    <div id="comment-avis">
        <h2>Vous pouvez laisser un commentaire :</h2>
        <br>
        <div class="form-comment">
            <form id="addCommentSubject" method="POST" action="{{ url_for('user.comment_subject', user_pseudo=current_user.pseudo, subject_id=subject.id) }}">
                {{ formcomment.csrf_token }}
                <input type="hidden" name="subject_id" value="{{ subject.id }}">
                <input type="hidden" name="user_pseudo" value="{{ current_user.pseudo }}">
                <textarea name="comment_content" placeholder="Votre commentaire" required></textarea>
                <button type="submit">Poster le commentaire</button>
            </form>
        </div>
    </div>
    <div class="separation"></div>
</section>
<div>
    <button class="back"><a href="{{ url_for('frontend.forum') }}">Retour au forum</a></button>
</div>

{% endblock %}
{% block footer_content %}
<script src="{{ url_for('static', filename='CSS/javascript/like_comment_subject.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var form = document.getElementById('addCommentSubject');

    // Variable JavaScript indiquant si l'utilisateur est connecté
    var isAuthenticated = {{ is_authenticated|tojson }};

    form.addEventListener('submit', function(event) {
        if (!isAuthenticated) {
            // Afficher une alerte si l'utilisateur n'est pas connecté
            alert("Vous devez être connecté pour ajouter un commentaire à ce sujet.");
            event.preventDefault(); // Empêche la soumission du formulaire
            }
    });
});
</script>
{% endblock %}
